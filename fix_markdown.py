import re

with open('ZENO LocalFlow — Business Plan.md', 'r', encoding='utf-8') as f:
    content = f.read()

# Fix broken headers
content = content.replace(
    '## **ZENO LocalFlow построен по принципу:\n\n"Облако управляет, устройство считывает и обрабатывает."**',
    '## **ZENO LocalFlow построен по принципу: "Облако управляет, устройство считывает и обрабатывает."**'
)

content = content.replace(
    '## **Европа — один из самых крупных и фрагментированных финансовых рынков мира.\n\nА локальные бухгалтерские фирмы испытывают острую потребность  \nв безопасной автоматизации финансовых документов.**',
    '## **Европа — один из самых крупных и фрагментированных финансовых рынков мира. А локальные бухгалтерские фирмы испытывают острую потребность в безопасной автоматизации финансовых документов.**'
)

content = content.replace(
    '## **ZENO LocalFlow — это SaaS с лёгкой инфраструктурой и высокой маржой.\n\nФинансовая модель проста, прозрачна и масштабируема.**',
    '## **ZENO LocalFlow — это SaaS с лёгкой инфраструктурой и высокой маржой. Финансовая модель проста, прозрачна и масштабируема.**'
)

content = content.replace(
    '## **ZENO LocalFlow — первый FinTech инструмент на Кипре,\n\nкоторый объединяет преимущества SaaS и безопасность локальной обработки данных.**',
    '## **ZENO LocalFlow — первый FinTech инструмент на Кипре, который объединяет преимущества SaaS и безопасность локальной обработки данных.**'
)

content = content.replace(
    '## **Рынок автоматизации финансовых документов существует,\n\nно ни один конкурент не решает главную проблему —  \nстрах передачи данных в облако.**',
    '## **Рынок автоматизации финансовых документов существует, но ни один конкурент не решает главную проблему — страх передачи данных в облако.**'
)

content = content.replace(
    '## **ZENO LocalFlow единственный на рынке использует модель:\n\n"Cloud SaaS + Local Processing (Go-WASM)"**',
    '## **ZENO LocalFlow единственный на рынке использует модель: "Cloud SaaS + Local Processing (Go-WASM)"**'
)

# Fix unclosed mermaid blocks
content = content.replace(
    '```mermaid\nline\n    title ARR Growth (3 years)\n    x-axis 2026, 2027, 2028\n    y-axis €0, €100k, €200k, €300k, €400k, €500k\n    2026: 58800\n    2027: 235200\n    2028: 470400\n\n\n# **8. ДОРОЖНАЯ КАРТА ПРОЕКТА',
    '```mermaid\nline\n    title ARR Growth (3 years)\n    x-axis 2026, 2027, 2028\n    y-axis €0, €100k, €200k, €300k, €400k, €500k\n    2026: 58800\n    2027: 235200\n    2028: 470400\n```\n\n---\n\n# **8. ДОРОЖНАЯ КАРТА ПРОЕКТА'
)

content = content.replace(
    '    Подготовка к Германии (этап 1)      :2026-11, 45d\n\n\n# **9. КОМАНДА ПРОЕКТА',
    '    Подготовка к Германии (этап 1)      :2026-11, 45d\n```\n\n---\n\n# **9. КОМАНДА ПРОЕКТА'
)

# Remove duplicate sections 9 and 10
lines = content.split('\n')
result_lines = []
skip_until = None
section_9_count = 0
section_10_count = 0

for i, line in enumerate(lines):
    if '# **9. КОМАНДА ПРОЕКТА (THE TEAM)**' in line:
        section_9_count += 1
        if section_9_count == 2:
            skip_until = '# **10. ФИНАНСОВЫЙ ЗАПРОС'
            continue
    
    if '# **10. ФИНАНСОВЫЙ ЗАПРОС И ИСПОЛЬЗОВАНИЕ СРЕДСТВ' in line:
        section_10_count += 1
        if section_10_count == 2:
            skip_until = '# **11. ФИНАНСОВЫЕ ПРОГНОЗЫ'
            continue
    
    if skip_until and skip_until in line:
        skip_until = None
        result_lines.append(line)
        continue
    
    if not skip_until:
        result_lines.append(line)

content = '\n'.join(result_lines)

# Fix broken mermaid in section 12
content = re.sub(
    r'```mermaid\nflowchart TD.*?end\n\n12\.4\. Как работает Zeno CY',
    '```mermaid\nflowchart TD\n\n    A[Пользователь<br>Бухгалтер / фирма] --> B[Web App<br>(React/Next.js)]\n\n    B --> C[WASM Engine<br>(Go → WebAssembly)]\n    C -->|Локально| D[(Входящие документы:<br>CSV / XLSX / PDF*)]\n\n    B --> E[Backend API<br>(Go, Cloud Run)]\n    E --> F[(Meta-хранилище:<br>логины, настройки)]\n\n    C --> G[Результат<br>готовая таблица]\n    G --> B\n\n    subgraph Local Environment\n        C\n        D\n    end\n\n    subgraph Cloud (GDPR Safe)\n        E\n        F\n    end\n```\n\n---\n\n# **12.4. Как работает Zeno CY',
    content,
    flags=re.DOTALL
)

# Fix broken lists after mermaid
content = re.sub(
    r'12\.4\. Как работает Zeno CY\nШаг 1 — Загрузка документов\n\nПользователь загружает CSV/XLSX-файлы в браузер\.\nФайлы не отправляются в облако\.\n\nШаг 2 — Локальная обработка \(WASM Engine\)\n\nВеб-приложение вызывает WASM-модуль — миниатюрный локальный "движок" на Go\.\n\nОн делает:\n\nпарсинг выписок,\n\nнормализацию форматов,\n\nвалидацию данных,\n\nустранение типичных ошибок,\n\nунификацию колонок\.\n\nВсе операции выполняются внутри браузера, на устройстве пользователя\.\n\nШаг 3 — Облачный бэкенд\n\nСервер получает только технические данные:\n\nID пользователя\n\nвремя операции\n\nколичество файлов\n\nнастройки обработки\n\nСам файл, строки и банковские данные — не уходят в облако\.\n\nШаг 4 — Готовая таблица\n\nРезультат возвращается оператору в виде:\n\nстандартизированной таблицы,\n\nCSV или Excel,\n\nпредпросмотра в браузере,\n\nфайла для импорта в бухгалтерское ПО\.\n\n12\.5\. Почему это безопасно \(GDPR-by-design\)\n\nНаш подход основан на трёх принципах:\n\n1\) Zero Retention\n\nМы не храним документы, строки, транзакции и финансовые данные\.\n\n2\) Zero Knowledge\n\nМы технически не знаем содержание финансовых документов клиента\.\n\n3\) Local First\n\nОбработка производится на устройстве, а не на сервере\.\n\nЭтот принцип полностью соответствует требованиям европейских регуляторов\nи фактически устраняет риски, связанные с:\n\nпередачей финансовых данных в облако,\n\nутечками,\n\nошибками конфигурации,\n\nсторонними подрядчиками\.\n\n12\.6\. Преимущества архитектуры\nТехнические\tБизнесовые\n• Go → WASM: высокая скорость\t• Минимальные требования GDPR\n• Zero Retention\t• Клиенты доверяют локальной обработке\n• Минимальный нагрузочный профиль на облако\t• Низкая цена подписки \(нет больших OpEx\)\n• Не требует установки приложений\t• Внедрение за 30 секунд\n• Совместимость с любой ОС\t• Масштабирование без "костылей"\n12\.7\. Что даёт эта архитектура инкубатору\n\nZeno CY создаёт новый класс FinTech-продуктов:\nоблачные SaaS-сервисы, которые не касаются пользовательских данных\.\n\nЭто открывает путь к:\n\nпартнёрствам с банками,\n\nработе с fiduciary-фирмами,\n\nофлайн- и онлайн-бухгалтериями,\n\nработе в индустриях, где хранение данных запрещено \(юристы, аудиторы\)\.\n\n<p align="center"> <img src="architecture-divider\.png" width="400"/> </p> ```',
    '# **12.4. Как работает Zeno CY**\n\n## **Шаг 1 — Загрузка документов**\n\nПользователь загружает CSV/XLSX-файлы в браузер.  \nФайлы не отправляются в облако.\n\n## **Шаг 2 — Локальная обработка (WASM Engine)**\n\nВеб-приложение вызывает WASM-модуль — миниатюрный локальный "движок" на Go.\n\nОн делает:\n- парсинг выписок\n- нормализацию форматов\n- валидацию данных\n- устранение типичных ошибок\n- унификацию колонок\n\nВсе операции выполняются внутри браузера, на устройстве пользователя.\n\n## **Шаг 3 — Облачный бэкенд**\n\nСервер получает только технические данные:\n- ID пользователя\n- время операции\n- количество файлов\n- настройки обработки\n\nСам файл, строки и банковские данные — не уходят в облако.\n\n## **Шаг 4 — Готовая таблица**\n\nРезультат возвращается оператору в виде:\n- стандартизированной таблицы\n- CSV или Excel\n- предпросмотра в браузере\n- файла для импорта в бухгалтерское ПО\n\n---\n\n# **12.5. Почему это безопасно (GDPR-by-design)**\n\nНаш подход основан на трёх принципах:\n\n### **1) Zero Retention**\nМы не храним документы, строки, транзакции и финансовые данные.\n\n### **2) Zero Knowledge**\nМы технически не знаем содержание финансовых документов клиента.\n\n### **3) Local First**\nОбработка производится на устройстве, а не на сервере.\n\nЭтот принцип полностью соответствует требованиям европейских регуляторов  \nи фактически устраняет риски, связанные с:\n- передачей финансовых данных в облако\n- утечками\n- ошибками конфигурации\n- сторонними подрядчиками\n\n---\n\n# **12.6. Преимущества архитектуры**\n\n| Технические | Бизнесовые |\n|-------------|------------|\n| Go → WASM: высокая скорость | Минимальные требования GDPR |\n| Zero Retention | Клиенты доверяют локальной обработке |\n| Минимальный нагрузочный профиль на облако | Низкая цена подписки (нет больших OpEx) |\n| Не требует установки приложений | Внедрение за 30 секунд |\n| Совместимость с любой ОС | Масштабирование без "костылей" |\n\n---\n\n# **12.7. Что даёт эта архитектура инкубатору**\n\nZeno CY создаёт новый класс FinTech-продуктов:  \nоблачные SaaS-сервисы, которые не касаются пользовательских данных.\n\nЭто открывает путь к:\n- партнёрствам с банками\n- работе с fiduciary-фирмами\n- офлайн- и онлайн-бухгалтериями\n- работе в индустриях, где хранение данных запрещено (юристы, аудиторы)\n\n---\n\n<p align="center">\n  <img src="architecture-divider.png" width="400"/>\n</p>',
    content,
    flags=re.DOTALL
)

with open('ZENO LocalFlow — Business Plan.md', 'w', encoding='utf-8') as f:
    f.write(content)

print("Done! All markdown errors fixed!")
